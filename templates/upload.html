<form action="{% url 'upload' %}" method="post">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Fetch playlist</button>
</form>

{% if filename %}
  <p><strong>Playlist:</strong> {{ filename }} — {{ count_total }} tracks found</p>
{% endif %}

{% if preview %}
  <h2>Preview (first 10)</h2>
  <table>
    <tr>
      <th>Title</th><th>Artist</th><th>Album</th><th>ISRC</th><th>Norm Title</th><th>Norm Artist</th>
    </tr>
    {% for row in preview %}
    <tr>
      <td>{{ row.raw_title }}</td>
      <td>{{ row.raw_artist }}</td>
      <td>{{ row.raw_album }}</td>
      <td>{{ row.raw_isrc }}</td>
      <td>{{ row.norm_title }}</td>
      <td>{{ row.norm_artist }}</td>
    </tr>
    {% endfor %}
  </table>
{% endif %}

{% if uploaded_ok %}
  <p>{{ track_count }} tracks parsed and cached.</p>

  <button id="btnSample">Run Sample Match</button>
  <button id="btnAll">Run Full Match</button>

  <pre id="out" style="white-space: pre-wrap; background:#111; padding:1rem; border-radius:8px;"></pre>

  <script>
    async function postJSON(url) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'X-CSRFToken': getCookie('csrftoken') }
      });
      // show any non-200s as text for debugging
      if (!resp.ok) {
        const txt = await resp.text();
        return { error: resp.status + ' ' + resp.statusText, body: txt };
      }
      return resp.json();
    }
    function getCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }

    const out = document.getElementById('out');
    document.getElementById('btnSample').onclick = async () => {
      out.textContent = "Running sample match…";
      const data = await postJSON("{% url 'match' %}");
      out.textContent = JSON.stringify(data, null, 2);
    };
    document.getElementById('btnAll').onclick = async () => {
      out.textContent = "Running full match…";
      const data = await postJSON("{% url 'match' %}?scope=all");
      out.textContent = JSON.stringify(data, null, 2);
    };
  </script>
{% endif %}
