<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Matching…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <style>
    :root{
      --bg:#000;
      --panel:rgba(20,20,20,0.9);
      --border:#2b2b2b;
      --text:#fff;
      --muted:#bdbdbd;
      --accent:#1db954;
      --accent-2:#1ed760;
    }
    *{box-sizing:border-box}
    html,body{height:100%}

    /* Vertically center the stack */
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:var(--bg);
      display:flex;
      flex-direction:column;
      align-items:center;          /* center horizontally */
      justify-content:center;      /* center vertically */
      min-height:100vh;
      padding:24px 16px;
      gap:14px;                    /* space between progress block and facts */
      overflow-x:hidden;
      text-align:center;
    }

    /* Background canvas */
    #bg{
      position:fixed;
      inset:0;
      width:100vw;height:100vh;
      z-index:-2;
      background:
        radial-gradient(1100px 700px at 70% 15%, rgba(28,28,28,0.55), transparent 60%),
        radial-gradient(900px 600px at 20% 85%, rgba(22,22,22,0.6), transparent 65%),
        #000;
    }

    a.home-link{
      position:absolute; top:20px; left:20px;
      text-decoration:none; color:var(--muted); font-weight:600;
      border:1px solid var(--border); padding:.5rem .8rem; border-radius:10px;
      backdrop-filter:blur(2px);
      transition:background .15s ease,border-color .15s ease;
    }
    a.home-link:hover{background:rgba(30,30,30,.6);border-color:#3a3a3a;}

    /* Progress block */
    .center-stack{
      width:min(780px,92vw);
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;        /* internal spacing */
      margin:0;
    }
    @media (max-width:560px){
      body{ padding-top:60px; } /* keep Home button from overlapping on small screens */
      .center-stack{ width:min(96vw,560px); }
    }

    h1{ margin:0; font-size:clamp(1.3rem,4vw,2rem); }

    .bar-wrap{
      width:100%;
      height:28px;
      background:#111;
      border-radius:999px;
      overflow:hidden;
      border:1px solid var(--border);
      margin:0;
    }
    .bar{
      height:100%;
      width:0%;
      background:var(--accent);
      transition:width .18s ease;
      box-shadow:0 6px 18px rgba(29,185,84,.25) inset;
    }

    .row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      margin:0;
    }
    .muted{ color:var(--muted); }
    .error{ color:#f88; margin-top:8px; }

    /* Facts panel (outer box) — fixed height set via JS to fit longest fact */
    .facts{
      width:min(860px,92vw);
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:1rem 1.2rem;
      box-shadow:0 0 30px rgba(0,0,0,.7);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      text-align:left;
      overflow:hidden; /* keep height stable while inner content fades */
    }
    .facts h2{
      margin:.15rem 0 .35rem;
      font-size:clamp(1rem,2.6vw,1.1rem);
      letter-spacing:.01em;
      color:#eaeaea;
      opacity:.9;
    }

    /* Inner fact box (content may vary, outer stays fixed) */
    .fact-box{
      border:1px solid #333;
      background:#0f0f0f;
      border-radius:12px;
      padding:1rem 1.1rem;
      display:flex;
      align-items:center;
      line-height:1.55;
      color:#ddd;
    }

    /* Smooth fade for fact text */
    @keyframes factFade { from{opacity:0;} to{opacity:1;} }
    .fact-text{
      font-size: clamp(.98rem, 2.4vw, 1.05rem);
      animation: factFade .7s ease-out;
    }
  </style>
</head>
<body data-job-id="{{ job_id }}" data-total="{{ total|default:0 }}">
  <canvas id="bg" aria-hidden="true"></canvas>

  <a href="{% url 'landing' %}" class="home-link">← Home</a>

  <div class="center-stack">
    <h1>Matching your playlist…</h1>

    <div class="bar-wrap" aria-hidden="true"><div id="bar" class="bar"></div></div>
    <div class="row">
      <div id="pct"><strong>0%</strong></div>
      <div class="muted" id="counts">0 / {{ total|default:"?" }}</div>
    </div>
    <p class="muted">Please keep this tab open while we match tracks.</p>

    <div id="err" class="error" role="alert" style="display:none;"></div>
  </div>

  <!-- Facts panel -->
  <section id="factsPanel" class="facts" aria-live="polite" aria-atomic="true">
    <h2>Did you know?</h2>
    <div class="fact-box">
      <div id="factText" class="fact-text">Loading a cool music fact…</div>
    </div>
  </section>

  <!-- Starfield background -->
  <script>
    // ====== Starfield + connecting lines (lightweight) ======
    (function () {
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const canvas = document.getElementById('bg');
      const ctx = canvas.getContext('2d');

      let w, h, dpr, particles, running = !prefersReduced;
      const MAX_PARTICLES = 120;
      const LINK_DIST = 110;
      const SPEED = 0.08;

      function resize() {
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        w = canvas.width = Math.floor(window.innerWidth * dpr);
        h = canvas.height = Math.floor(window.innerHeight * dpr);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        initParticles();
      }

      function initParticles() {
        const count = Math.min(MAX_PARTICLES, Math.round((window.innerWidth * window.innerHeight) / 14000));
        particles = [];
        for (let i = 0; i < count; i++) {
          particles.push({
            x: Math.random() * w,
            y: Math.random() * h,
            vx: (Math.random() * 2 - 1) * SPEED * dpr,
            vy: (Math.random() * 2 - 1) * SPEED * dpr,
            r: (Math.random() * 1.6 + 0.6) * dpr,
            twinkle: Math.random() * Math.PI * 2
          });
        }
      }

      let last = performance.now();
      function frame(now) {
        if (!running) return;
        const dt = Math.min(now - last, 50);
        last = now;

        ctx.clearRect(0, 0, w, h);

        // Draw links
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        for (let i = 0; i < particles.length; i++) {
          const a = particles[i];
          for (let j = i + 1; j < particles.length; j++) {
            const b = particles[j];
            const dx = a.x - b.x;
            const dy = a.y - b.y;
            const dist = Math.hypot(dx, dy);
            if (dist < LINK_DIST * dpr) {
              const alpha = 0.08 * (1 - dist / (LINK_DIST * dpr));
              ctx.strokeStyle = `rgba(180, 180, 180, ${alpha})`;
              ctx.lineWidth = dpr * 0.6;
              ctx.beginPath();
              ctx.moveTo(a.x, a.y);
              ctx.lineTo(b.x, b.y);
              ctx.stroke();
            }
          }
        }
        ctx.restore();

        // Draw stars
        for (const p of particles) {
          p.x += p.vx * dt;
          p.y += p.vy * dt;

          if (p.x < -20) p.x = w + 20;
          if (p.x > w + 20) p.x = -20;
          if (p.y < -20) p.y = h + 20;
          if (p.y > h + 20) p.y = -20;

          p.twinkle += dt * 0.003;
          const glow = 0.2 + Math.sin(p.twinkle) * 0.4;

          const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r * 4);
          grad.addColorStop(0, `rgba(255,255,255,${0.6 * glow})`);
          grad.addColorStop(1, 'rgba(255,255,255,0)');
          ctx.fillStyle = grad;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r * 4, 0, Math.PI * 2); ctx.fill();

          ctx.fillStyle = `rgba(255,255,255,${0.95 * glow})`;
          ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2); ctx.fill();
        }

        requestAnimationFrame(frame);
      }

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) { running = false; }
        else if (!prefersReduced) { running = true; last = performance.now(); requestAnimationFrame(frame); }
      });

      window.addEventListener('resize', resize, { passive:true });
      resize();
      if (!prefersReduced) requestAnimationFrame(frame);
    })();
  </script>

  <!-- Facts: 10 diverse, interesting music nuggets -->
  <script>
    const MUSIC_FACTS = [
      "The oldest surviving written melody is the “Hurrian Hymn No. 6,” dating to around 1400 BCE from ancient Ugarit.",
      "John Cage’s piece 4′33″ instructs performers to remain silent, highlighting ambient sound as the music.",
      "A standard modern piano keyboard has 88 keys spanning a range of just over seven octaves.",
      "Stradivarius violins are prized for their craftsmanship and tone, with some valued at millions of dollars.",
      "Vinyl records have seen a major resurgence in the 2010s and 2020s, with annual sales climbing again.",
      "The ISRC (International Standard Recording Code) uniquely identifies sound recordings for tracking and royalties.",
      "Wolfgang Amadeus Mozart composed more than 600 works across symphonies, operas, chamber music, and more.",
      "The theremin is one of the only instruments played without physical contact, using hand proximity to control pitch and volume.",
      "Michael Jackson’s “Thriller” is among the best-selling albums of all time and reshaped the music video era.",
      "The Beatles hold the record for the most Billboard Hot 100 No. 1 hits by a group."
    ];

    (function factsRotator(){
      const factsPanel = document.getElementById("factsPanel");
      const factBox = factsPanel.querySelector(".fact-box");
      const el = document.getElementById("factText");
      const INTERVAL_MS = 7000; // 7 seconds

      let lastIndex = -1;
      let timer;

      function pickIndex(){
        if (MUSIC_FACTS.length <= 1) return 0;
        let i = Math.floor(Math.random() * MUSIC_FACTS.length);
        if (i === lastIndex) i = (i + 1) % MUSIC_FACTS.length; // avoid immediate repeats
        lastIndex = i;
        return i;
      }

      // Measure tallest fact and lock OUTER panel height
      function lockFactsPanelHeight(){
        const clone = factsPanel.cloneNode(true);
        clone.style.position = "absolute";
        clone.style.visibility = "hidden";
        clone.style.pointerEvents = "none";
        clone.style.left = "-9999px";
        clone.style.height = "auto";
        document.body.appendChild(clone);

        const cBox = clone.querySelector(".fact-box");
        const cText = clone.querySelector(".fact-text");

        let maxBoxH = 0;
        for (const f of MUSIC_FACTS){
          cText.textContent = f;
          cBox.style.width = factBox.clientWidth + "px";
          cBox.style.height = "auto";
          const h = cBox.offsetHeight;
          if (h > maxBoxH) maxBoxH = h;
        }

        const styles = getComputedStyle(factsPanel);
        const padY = parseFloat(styles.paddingTop) + parseFloat(styles.paddingBottom);
        const headerH = factsPanel.querySelector("h2").offsetHeight;
        factsPanel.style.height = (headerH + padY + maxBoxH) + "px";

        document.body.removeChild(clone);
      }

      function showFact() {
        el.style.animation = "none";
        void el.offsetWidth;
        el.textContent = MUSIC_FACTS[pickIndex()];
        el.style.animation = "factFade .7s ease-out";
      }

      function onResizeDebounced(){
        clearTimeout(timer);
        timer = setTimeout(lockFactsPanelHeight, 100);
      }

      showFact();
      requestAnimationFrame(lockFactsPanelHeight);
      setInterval(showFact, INTERVAL_MS);
      window.addEventListener("resize", onResizeDebounced, { passive:true });
    })();
  </script>

  <!-- Progress logic (unchanged) -->
  <script>
    function getCookie(name) {
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? decodeURIComponent(m.pop()) : '';
    }

    (function () {
      const jobId = document.body.dataset.jobId || '';
      let totalCount = Number(document.body.dataset.total || '0') || 0;

      const bar = document.getElementById('bar');
      const pct = document.getElementById('pct');
      const counts = document.getElementById('counts');
      const err = document.getElementById('err');

      let localDone = 0;
      const BATCH_SIZE = 10;
      const MAX_POLLS = 2000;
      let polls = 0;

      function paint(done, total) {
        const t = total || totalCount || 1;
        const p = Math.floor((done / t) * 100);
        bar.style.width = p + '%';
        pct.innerHTML = `<strong>${p}%</strong>`;
        counts.textContent = `${done} / ${t}`;
      }

      function animateSongs(n, total, after) {
        if (n <= 0) { after(); return; }
        localDone += 1;
        paint(localDone, total);
        setTimeout(() => animateSongs(n - 1, total, after), 90);
      }

      async function step() {
        if (++polls > MAX_POLLS) throw new Error('Too many polling attempts — aborting.');
        const url = `/match/run/${encodeURIComponent(jobId)}?batch=${BATCH_SIZE}`;
        const resp = await fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });

        if (!resp.ok) throw new Error(await resp.text() || ('HTTP ' + resp.status));

        const data = await resp.json();
        const serverDone = Number(data.done || 0);
        const processed = Number(data.processed || 0);

        if ((data.total || 0) > 0) totalCount = Number(data.total);
        const total = totalCount > 0 ? totalCount : (Number(data.total || 0) || 1);

        if (localDone < serverDone - processed) {
          localDone = serverDone - processed;
          paint(localDone, total);
        }

        animateSongs(processed, total, () => {
          if (data.status === 'done' && total > 0 && serverDone >= total) {
            window.location.href = `/match/results/${encodeURIComponent(jobId)}?created=0`;
            return;
          }
          setTimeout(step, 120);
        });
      }

      if (!jobId) {
        err.textContent = 'Missing job id. Please start the match again.';
        err.style.display = 'block';
        return;
      }

      paint(0, totalCount);
      step().catch((e) => {
        console.error(e);
        err.textContent = 'Matching failed: ' + (e.message || 'Unknown error');
        err.style.display = 'block';
      });
    })();
  </script>
</body>
</html>
